#!/bin/bash

# shellcheck source=meta-facebook/meta-harma/recipes-phosphor/state/phosphor-state-manager/power-cmd
source /usr/libexec/phosphor-state-manager/power-cmd
renice -10 $$

# Check SGPIO validity
if ! check_valid_sgpio; then
    echo "SGPIO invalid, skipping power good assertion"
    exit 0
fi

# Sync Led status to on
systemctl start obmc-led-group-stop@power_on.service

# Get current host state
current_state=$(busctl get-property \
    xyz.openbmc_project.State.Host0 \
    /xyz/openbmc_project/state/host0 \
    xyz.openbmc_project.State.Host \
    CurrentHostState | awk '{print $2}' | tr -d '"')

# Exit if host is already transitioning off
if [ "$current_state" = "xyz.openbmc_project.State.Host.HostState.TransitioningToOff" ]; then
    echo "Host is transitioning to off, skipping power good assertion"
    exit 0
fi

# List of services that block power_off_sync
block_services=(
    host-graceful-poweroff@0.service
    host-force-poweroff@0.service
    host-powerreset@0.service
)

# Check each service's state
for svc in "${block_services[@]}"; do
    # Get the detailed SubState (e.g., running, exited, dead)
    substate=$(systemctl show -p SubState --value "$svc")
    # Get the general active state (e.g., active, inactive, activating)
    active_state=$(systemctl is-active "$svc")

    # LOGIC: If the service is NOT 'inactive' AND NOT 'exited', it is considered busy.
    # This covers states like 'active (running)', 'activating', and 'deactivating'.
    if [ "$active_state" != "inactive" ] && [ "$substate" != "exited" ]; then
        echo "Blocking service $svc is busy ($active_state/$substate), skipping process"
        exit 0
    fi
done

# Safe to power off
# Wait 2 seconds, checking every second
power_off_sync 2 1

exit 0
